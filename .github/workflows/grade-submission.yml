name: Grade Submission

on:
  pull_request:
    paths: ['ex1_*.py']

permissions:
  contents: read

jobs:
  grade:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Find student submission
        id: find
        run: |
          for file in ex1_*.py; do
            if [ -f "$file" ]; then
              USER="${file#ex1_}"
              USER="${USER%.py}"
              echo "file=$file" >> $GITHUB_OUTPUT
              echo "user=$USER" >> $GITHUB_OUTPUT
              break
            fi
          done

          [ -z "${{ steps.find.outputs.file }}" ] && exit 1

      - name: Build grader image
        uses: docker/build-push-action@v5
        with:
          context: ./docker
          load: true
          tags: sandbox-runner:latest

      - name: Run evaluation
        id: grade
        run: |
          mkdir -p work
          cp "${{ steps.find.outputs.file }}" work/student.py

          docker run --rm \
            -v "$PWD/work:/data" \
            sandbox-runner:latest \
            /data/student.py \
            "${{ steps.find.outputs.user }}"

          SCORE=$(sqlite3 work/results.db \
            "SELECT result_score FROM submissions ORDER BY id DESC LIMIT 1;" \
            2>/dev/null || echo 0)

          echo "score=$SCORE" >> $GITHUB_OUTPUT

      - name: Upload grading artifact
        uses: actions/upload-artifact@v4
        with:
          name: grading-result
          path: work/results.db
          retention-days: 7

      - name: Publish student feedback
        run: |
          {
            echo "## ðŸŽ¯ Submission Graded"
            echo ""
            echo "**Student:** ${{ steps.find.outputs.user }}"
            echo "**Score:** ${{ steps.grade.outputs.score }}/100"
            echo ""
            echo "_This run is a preview. Results are finalized after merge._"
          } >> $GITHUB_STEP_SUMMARY
