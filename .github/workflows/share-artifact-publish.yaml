name: Workflow C - Publish Database to Pages

on:
  # Trigger on a schedule (every hour at minute 0)
  schedule:
    - cron: '0 * * * *'
  # ALSO trigger when Workflow B completes successfully
  workflow_run:
    workflows: ["Workflow B - With Persistent Database"] # Use the exact name of your Workflow B
    types:
      - completed

# This permission is needed to deploy to GitHub Pages
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  generate-and-deploy-page:
    # Only run if triggered by schedule OR if the triggering Workflow B was successful
    if: >
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_run' && 
       github.event.workflow_run.conclusion == 'success')
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Download the latest database artifact
        uses: actions/download-artifact@v4
        with:
          # Use the consistent name from Workflow B
          name: workflow-database
          # The artifact contains a .zip, extract it here
          path: ./db-source

      - name: Set up SQLite
        run: sudo apt-get install -y sqlite3

      - name: Query database and generate HTML
        run: |
          DB_PATH="./db-source/workflow.db"
          OUTPUT_PATH="./_site/index.html" # GitHub Pages publishes from /_site or /docs
          
          # Create output directory
          mkdir -p "$(dirname "$OUTPUT_PATH")"
          
          # Query the database and generate a simple HTML page
          # This is a basic example. You can make the query and HTML as complex as you need.
          cat > "$OUTPUT_PATH" <<EOF
          <!DOCTYPE html>
          <html>
          <head>
              <title>Workflow History</title>
              <meta charset="utf-8">
              <meta name="viewport" content="width=device-width, initial-scale=1">
              <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
          </head>
          <body class="bg-light">
              <div class="container mt-5">
                  <h1 class="mb-4">ðŸ“Š Workflow Execution History</h1>
                  <p class="text-muted">Last updated: $(date)</p>
                  <div class="table-responsive">
                      <table class="table table-striped table-hover">
                          <thead class="table-dark">
                              <tr>
                                  <th>ID</th>
                                  <th>Execution Date</th>
                                  <th>Message</th>
                                  <th>Workflow A ID</th>
                                  <th>Workflow B ID</th>
                                  <th>Recorded At (UTC)</th>
                              </tr>
                          </thead>
                          <tbody>
          EOF
          
          # Use SQLite to query and append rows to the HTML table
          sqlite3 "$DB_PATH" <<'SQL' >> "$OUTPUT_PATH"
          .mode html
          SELECT 
              id,
              processing_date,
              '<span style="font-family: monospace;">' || substr(message, 1, 60) || '</span>',
              '<a href="https://github.com/${{ github.repository }}/actions/runs/' || workflow_a_id || '">' || substr(workflow_a_id, 1, 8) || '</a>',
              '<a href="https://github.com/${{ github.repository }}/actions/runs/' || workflow_b_id || '">' || substr(workflow_b_id, 1, 8) || '</a>',
              created_at
          FROM workflow_history
          ORDER BY id DESC;
          SQL
          
          cat >> "$OUTPUT_PATH" <<EOF
                          </tbody>
                      </table>
                  </div>
                  <footer class="mt-5 text-center text-muted">
                      <p>Automatically generated by <a href="https://github.com/${{ github.repository }}">GitHub Actions</a>.</p>
                  </footer>
              </div>
          </body>
          </html>
          EOF
          
          echo "HTML page generated at $OUTPUT_PATH"
          echo "Total records displayed: $(sqlite3 "$DB_PATH" "SELECT COUNT(*) FROM workflow_history;")"

      - name: Upload artifact for GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./_site  # Upload the directory containing your static site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4