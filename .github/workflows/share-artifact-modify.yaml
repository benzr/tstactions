# .github/workflows/workflow-b-simple-persistent.yml
name: Workflow B - Simple Persistent DB

on:
  workflow_run:
    workflows: ["Workflow A - Sender"]
    types:
      - completed

permissions:
  actions: read
  contents: write

jobs:
  process-data:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup SQLite
        run: sudo apt-get install -y sqlite3
        
      - name: Download Latest Database (if exists)
        id: download-db
        uses: dawidd6/action-download-artifact@v6
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          name: workflow-database
          workflow: workflow-b-simple-persistent.yml
          branch: main
          check_artifacts: true
          allow_fetching_workflows_from_other_repos: false
          
      - name: Download Workflow A Data
        uses: actions/download-artifact@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
          name: shared-data-from-a
          path: ./input-data
          
      - name: Initialize Database
        run: |
          DB_FILE="workflow.db"
          
          # If no database was downloaded, create new one
          if [ ! -f "$DB_FILE" ]; then
            echo "Creating new database..."
            sqlite3 $DB_FILE <<EOF
            CREATE TABLE executions (
              id INTEGER PRIMARY KEY AUTOINCREMENT,
              message TEXT,
              date TEXT,
              workflow_a_run TEXT,
              workflow_b_run TEXT,
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            );
            EOF
          else
            echo "Using existing database with $(sqlite3 $DB_FILE "SELECT COUNT(*) FROM executions;") records"
          fi
          
      - name: Add New Record
        run: |
          DB_FILE="workflow.db"
          MESSAGE=$(cat input-data/shared-data.txt 2>/dev/null || echo "No message found")
          PROCESSED_MESSAGE=$(echo "$MESSAGE" | sed 's/sent/received/')
          TODAY=$(date '+%Y-%m-%d')
          
          # Add the new record
          sqlite3 $DB_FILE <<EOF
          INSERT INTO executions (message, date, workflow_a_run, workflow_b_run)
          VALUES ('$PROCESSED_MESSAGE', '$TODAY', '${{ github.event.workflow_run.id }}', '${{ github.run_id }}');
          EOF
          
          echo "Added record #$(sqlite3 $DB_FILE "SELECT last_insert_rowid();")"
          
      - name: Display All Records
        run: |
          DB_FILE="workflow.db"
          echo "=== ALL RECORDS IN DATABASE ==="
          sqlite3 $DB_FILE <<EOF
.mode box
.headers on
SELECT 
  id,
  substr(message, 1, 20) as message,
  date,
  workflow_a_run,
  workflow_b_run,
  created_at
FROM executions
ORDER BY id;
EOF
          
          echo ""
          echo "Total records: $(sqlite3 $DB_FILE "SELECT COUNT(*) FROM executions;")"
          
      - name: Upload Updated Database
        uses: actions/upload-artifact@v4
        with:
          name: workflow-database
          path: workflow.db
          retention-days: 90  # Keep it for a long time
          overwrite: true  # IMPORTANT: Overwrite the previous database
          
      - name: Upload Additional Reports
        uses: actions/upload-artifact@v4
        with:
          name: reports-${{ github.run_id }}
          path: |
            input-data/
          retention-days: 7